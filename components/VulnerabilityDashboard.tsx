
import React, { useState, useMemo, useEffect } from 'react';
import { Vulnerability, VulnerabilityStatus, CriticalityLevel } from '../types';
import { EditIcon, DeleteIcon, PlusIcon, FaShieldAlt, FaSearch, FaExclamationTriangle, FaCheckCircle, FaFilter, FaTimes, FaRobot, FaSpinner } from './common/Icons';
import Pagination from './common/Pagination';
import { scanForVulnerabilities, isAiConfigured } from '../services/geminiService';
import * as dataService from '../services/dataService';

interface VulnerabilityDashboardProps {
    vulnerabilities: Vulnerability[];
    onEdit: (vuln: Vulnerability) => void;
    onDelete: (id: string) => void;
    onCreate: () => void;
    initialFilter?: any;
    onClearInitialFilter?: () => void;
}

const getSeverityClass = (level: CriticalityLevel) => {
    switch (level) {
        case CriticalityLevel.Critical: return 'text-red-500 font-bold bg-red-500/10 border-red-500/30';
        case CriticalityLevel.High: return 'text-orange-400 font-semibold bg-orange-500/10 border-orange-500/30';
        case CriticalityLevel.Medium: return 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30';
        default: return 'text-gray-400 bg-gray-500/10 border-gray-500/30';
    }
};

const getStatusColor = (status: VulnerabilityStatus) => {
    switch (status) {
        case VulnerabilityStatus.Open: return 'text-red-400';
        case VulnerabilityStatus.InProgress: return 'text-blue-400';
        case VulnerabilityStatus.Mitigated: return 'text-yellow-400';
        case VulnerabilityStatus.Resolved: return 'text-green-400';
        case VulnerabilityStatus.FalsePositive: return 'text-gray-400';
        default: return 'text-gray-400';
    }
};

const VulnerabilityDashboard: React.FC<VulnerabilityDashboardProps> = ({ vulnerabilities, onEdit, onDelete, onCreate, initialFilter, onClearInitialFilter }) => {
    const [searchQuery, setSearchQuery] = useState('');
    const [filterSeverity, setFilterSeverity] = useState<string>('');
    const [filterStatus, setFilterStatus] = useState<string>('');
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(20);
    
    // AI Scan State
    const [isScanning, setIsScanning] = useState(false);
    const aiConfigured = isAiConfigured();

    useEffect(() => {
        if (initialFilter) {
            if (initialFilter.severity) setFilterSeverity(initialFilter.severity);
            if (initialFilter.status) setFilterStatus(initialFilter.status);
        }
    }, [initialFilter]);

    const handleClearFilters = () => {
        setSearchQuery('');
        setFilterSeverity('');
        setFilterStatus('');
        if (onClearInitialFilter) onClearInitialFilter();
    };

    const handleAutoScan = async () => {
        if (!aiConfigured) return;
        if (!confirm("Isto irá analisar o seu inventário (Sistemas Operativos e Software) usando a IA para encontrar possíveis CVEs conhecidos na base de dados NVD. Deseja continuar?")) return;

        setIsScanning(true);
        try {
            // 1. Gather Inventory Context
            const allData = await dataService.fetchAllData();
            const inventoryContext = new Set<string>();
            
            // Add OS versions
            allData.equipment.forEach((eq: any) => {
                if (eq.os_version) inventoryContext.add(`OS: ${eq.os_version}`);
                if (eq.description) inventoryContext.add(`Hardware: ${eq.description}`);
            });
            
            // Add Software Licenses
            allData.softwareLicenses.forEach((lic: any) => {
                inventoryContext.add(`Software: ${lic.productName}`);
            });

            if (inventoryContext.size === 0) {
                alert("Não foi encontrado inventário suficiente (OS ou Software) para analisar.");
                return;
            }

            // 2. Call AI Scanner
            const results = await scanForVulnerabilities(Array.from(inventoryContext).slice(0, 50)); // Limit to 50 items to respect token limits

            // 3. Process Results
            if (results.length > 0) {
                let addedCount = 0;
                for (const vuln of results) {
                    // Check if already exists to avoid dupes (simple check by CVE ID)
                    const exists = vulnerabilities.some(v => v.cve_id === vuln.cve_id);
                    if (!exists) {
                        await dataService.addVulnerability({
                            cve_id: vuln.cve_id,
                            description: vuln.description,
                            severity: vuln.severity as CriticalityLevel,
                            affected_software: vuln.affected_software,
                            remediation: vuln.remediation,
                            status: VulnerabilityStatus.Open,
                            published_date: new Date().toISOString().split('T')[0]
                        });
                        addedCount++;
                    }
                }
                
                if (addedCount > 0) {
                    alert(`${addedCount} novas vulnerabilidades potenciais detetadas e registadas. Por favor valide-as.`);
                    window.location.reload(); // Simple refresh to show new data
                } else {
                    alert("A análise foi concluída, mas as vulnerabilidades detetadas já existiam no sistema ou nenhuma nova foi encontrada.");
                }
            } else {
                alert("O scanner não detetou vulnerabilidades críticas óbvias com base na lista fornecida.");
            }

        } catch (error) {
            console.error("Auto scan failed:", error);
            alert("Erro ao executar o scanner automático.");
        } finally {
            setIsScanning(false);
        }
    };

    const filteredVulnerabilities = useMemo(() => {
        return vulnerabilities.filter(v => {
            const searchMatch = searchQuery === '' || 
                v.cve_id.toLowerCase().includes(searchQuery.toLowerCase()) ||
                v.affected_software?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                v.description.toLowerCase().includes(searchQuery.toLowerCase());
            
            const severityMatch = filterSeverity === '' || v.severity === filterSeverity;
            const statusMatch = filterStatus === '' || v.status === filterStatus;
            
            return searchMatch && severityMatch && statusMatch;
        }).sort((a, b) => {
            // Sort by severity first (Critical > Low), then by date
            const priority = { [CriticalityLevel.Critical]: 3, [CriticalityLevel.High]: 2, [CriticalityLevel.Medium]: 1, [CriticalityLevel.Low]: 0 };
            if (priority[a.severity] !== priority[b.severity]) {
                return priority[b.severity] - priority[a.severity];
            }
            return (b.published_date || '').localeCompare(a.published_date || '');
        });
    }, [vulnerabilities, searchQuery, filterSeverity, filterStatus]);

    const totalPages = Math.ceil(filteredVulnerabilities.length / itemsPerPage);
    const paginatedVulnerabilities = useMemo(() => {
        return filteredVulnerabilities.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
    }, [filteredVulnerabilities, currentPage, itemsPerPage]);

    return (
        <div className="bg-surface-dark p-6 rounded-lg shadow-xl">
            <div className="flex justify-between items-center mb-6 flex-wrap gap-4">
                <div>
                    <h2 className="text-xl font-semibold text-white flex items-center gap-2">
                        <FaShieldAlt className="text-red-500"/> 
                        Gestão de Vulnerabilidades (CVEs)
                    </h2>
                    <p className="text-sm text-on-surface-dark-secondary mt-1">
                        Monitorize e mitigue vulnerabilidades de segurança nos seus ativos de software e hardware.
                    </p>
                </div>
                <div className="flex gap-3">
                    <button 
                        onClick={handleAutoScan} 
                        disabled={isScanning || !aiConfigured}
                        className={`flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-500 transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed`}
                        title={!aiConfigured ? "Requer chave API Gemini" : "Analisar inventário com IA"}
                    >
                        {isScanning ? <FaSpinner className="animate-spin" /> : <FaRobot />}
                        {isScanning ? 'A analisar...' : 'Auto Scan (IA)'}
                    </button>
                    <button onClick={onCreate} className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors shadow-lg">
                        <PlusIcon /> Registar CVE
                    </button>
                </div>
            </div>

            {initialFilter && (
                <div className="bg-red-900/20 border border-red-500/50 text-red-200 text-sm rounded-lg p-3 mb-6 flex justify-between items-center">
                    <span className="flex items-center gap-2">
                        <FaFilter />
                        A filtrar por alerta de segurança
                    </span>
                    <button onClick={handleClearFilters} className="flex items-center gap-1 hover:text-white">
                        <FaTimes className="h-3 w-3" />
                        Limpar Filtro
                    </button>
                </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-900/30 p-4 rounded-lg border border-gray-700">
                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <FaSearch className="h-4 w-4 text-gray-400" />
                    </div>
                    <input
                        type="text"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="CVE-XXXX-XXXX, Software..."
                        className="w-full bg-gray-800 border border-gray-600 text-white rounded-md pl-10 p-2 text-sm focus:ring-red-500 focus:border-red-500"
                    />
                </div>
                <select
                    value={filterSeverity}
                    onChange={(e) => setFilterSeverity(e.target.value)}
                    className="bg-gray-800 border border-gray-600 text-white rounded-md p-2 text-sm focus:ring-red-500 focus:border-red-500"
                >
                    <option value="">Todas as Severidades</option>
                    {Object.values(CriticalityLevel).map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                    className="bg-gray-800 border border-gray-600 text-white rounded-md p-2 text-sm focus:ring-red-500 focus:border-red-500"
                >
                    <option value="">Todos os Estados</option>
                    {Object.values(VulnerabilityStatus).map(s => <option key={s} value={s}>{s}</option>)}
                </select>
            </div>

            <div className="grid grid-cols-1 gap-4">
                {paginatedVulnerabilities.length > 0 ? paginatedVulnerabilities.map(vuln => (
                    <div key={vuln.id} className="bg-surface-dark border border-gray-700 rounded-lg p-4 hover:border-gray-600 transition-colors">
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-3">
                                <span className={`px-3 py-1 text-xs rounded-full border uppercase tracking-wider ${getSeverityClass(vuln.severity)}`}>
                                    {vuln.severity}
                                </span>
                                <h3 className="text-lg font-bold text-white font-mono">{vuln.cve_id}</h3>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className={`text-sm font-medium flex items-center gap-1 ${getStatusColor(vuln.status)}`}>
                                    {vuln.status === VulnerabilityStatus.Resolved ? <FaCheckCircle /> : <FaExclamationTriangle />}
                                    {vuln.status}
                                </span>
                                <div className="flex gap-2 border-l border-gray-700 pl-3">
                                    <button onClick={() => onEdit(vuln)} className="text-blue-400 hover:text-blue-300 p-1" title="Editar">
                                        <EditIcon />
                                    </button>
                                    <button onClick={() => onDelete(vuln.id)} className="text-red-400 hover:text-red-300 p-1" title="Excluir">
                                        <DeleteIcon />
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <p className="text-on-surface-dark-secondary text-sm mb-3 line-clamp-2">{vuln.description}</p>
                        
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs text-gray-400 bg-gray-900/50 p-3 rounded">
                            <div>
                                <span className="font-bold text-gray-500 block mb-1">Software Afetado:</span>
                                <span className="text-white">{vuln.affected_software || 'Não especificado'}</span>
                            </div>
                            <div>
                                <span className="font-bold text-gray-500 block mb-1">Remediação / Patch:</span>
                                <span className="text-green-300">{vuln.remediation || 'Pendente'}</span>
                            </div>
                            {vuln.published_date && (
                                <div className="sm:col-span-2 border-t border-gray-700 pt-2 mt-1">
                                    Publicado em: {vuln.published_date}
                                </div>
                            )}
                        </div>
                    </div>
                )) : (
                    <div className="text-center py-12 bg-gray-800/30 rounded-lg border border-dashed border-gray-700">
                        <FaCheckCircle className="h-12 w-12 text-green-500/30 mx-auto mb-3"/>
                        <p className="text-on-surface-dark-secondary">Nenhuma vulnerabilidade registada com os filtros atuais.</p>
                    </div>
                )}
            </div>

            <Pagination
                currentPage={currentPage}
                totalPages={totalPages}
                onPageChange={setCurrentPage}
                itemsPerPage={itemsPerPage}
                onItemsPerPageChange={setItemsPerPage}
                totalItems={filteredVulnerabilities.length}
            />
        </div>
    );
};

export default VulnerabilityDashboard;
