
import React, { useState, useEffect } from 'react';
import Modal from './common/Modal';
import { Vulnerability, VulnerabilityStatus, CriticalityLevel } from '../types';
import { FaBug, FaShieldAlt } from 'react-icons/fa';

interface AddVulnerabilityModalProps {
    onClose: () => void;
    onSave: (vuln: Omit<Vulnerability, 'id'> | Vulnerability) => Promise<any>;
    vulnToEdit?: Vulnerability | null;
}

const AddVulnerabilityModal: React.FC<AddVulnerabilityModalProps> = ({ onClose, onSave, vulnToEdit }) => {
    const [formData, setFormData] = useState<Partial<Vulnerability>>({
        cve_id: '',
        description: '',
        severity: CriticalityLevel.Medium,
        status: VulnerabilityStatus.Open,
        affected_software: '',
        remediation: '',
        published_date: new Date().toISOString().split('T')[0]
    });
    const [errors, setErrors] = useState<Record<string, string>>({});

    useEffect(() => {
        if (vulnToEdit) {
            setFormData({ ...vulnToEdit });
        }
    }, [vulnToEdit]);

    const validate = () => {
        const newErrors: Record<string, string> = {};
        if (!formData.cve_id?.trim()) newErrors.cve_id = "O ID do CVE é obrigatório (ex: CVE-2024-0001).";
        if (!formData.affected_software?.trim()) newErrors.affected_software = "Indique o software afetado para facilitar a busca.";
        if (!formData.description?.trim()) newErrors.description = "A descrição é obrigatória.";
        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (!validate()) return;
        
        const dataToSave: any = { ...formData };
        
        if (vulnToEdit) {
            onSave({ ...vulnToEdit, ...dataToSave });
        } else {
            onSave(dataToSave);
        }
        onClose();
    };
    
    const modalTitle = vulnToEdit ? "Editar Vulnerabilidade" : "Registar Nova Vulnerabilidade (CVE)";

    return (
        <Modal title={modalTitle} onClose={onClose} maxWidth="max-w-2xl">
            <form onSubmit={handleSubmit} className="space-y-5">
                <div className="bg-red-900/20 border border-red-900/50 p-4 rounded-lg flex items-start gap-3">
                    <FaBug className="text-red-400 mt-1 text-xl" />
                    <div className="text-sm text-gray-300">
                        <p>Registe os detalhes da vulnerabilidade de segurança. Certifique-se de preencher o campo <strong>"Software Afetado"</strong> corretamente para correlacionar com o inventário de licenças.</p>
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label htmlFor="cve_id" className="block text-sm font-medium text-on-surface-dark-secondary mb-1">ID CVE</label>
                        <input 
                            type="text" 
                            name="cve_id" 
                            id="cve_id" 
                            value={formData.cve_id} 
                            onChange={handleChange} 
                            placeholder="Ex: CVE-2024-12345"
                            className={`w-full bg-gray-700 border text-white rounded-md p-2 font-mono ${errors.cve_id ? 'border-red-500' : 'border-gray-600'}`}
                        />
                        {errors.cve_id && <p className="text-red-400 text-xs italic mt-1">{errors.cve_id}</p>}
                    </div>
                    <div>
                        <label htmlFor="published_date" className="block text-sm font-medium text-on-surface-dark-secondary mb-1">Data de Publicação</label>
                        <input 
                            type="date" 
                            name="published_date" 
                            id="published_date" 
                            value={formData.published_date} 
                            onChange={handleChange} 
                            className="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2"
                        />
                    </div>
                </div>

                <div>
                    <label htmlFor="affected_software" className="block text-sm font-medium text-on-surface-dark-secondary mb-1">Software / Ativo Afetado</label>
                    <input 
                        type="text" 
                        name="affected_software" 
                        id="affected_software" 
                        value={formData.affected_software} 
                        onChange={handleChange} 
                        placeholder="Ex: Windows Server 2019, Adobe Acrobat, Switch Cisco..."
                        className={`w-full bg-gray-700 border text-white rounded-md p-2 ${errors.affected_software ? 'border-red-500' : 'border-gray-600'}`}
                    />
                    {errors.affected_software && <p className="text-red-400 text-xs italic mt-1">{errors.affected_software}</p>}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label htmlFor="severity" className="block text-sm font-medium text-on-surface-dark-secondary mb-1">Severidade</label>
                        <select name="severity" value={formData.severity} onChange={handleChange} className="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2">
                            {Object.values(CriticalityLevel).map(lvl => <option key={lvl} value={lvl}>{lvl}</option>)}
                        </select>
                    </div>
                    <div>
                         <label htmlFor="status" className="block text-sm font-medium text-on-surface-dark-secondary mb-1">Estado Atual</label>
                         <select name="status" value={formData.status} onChange={handleChange} className="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2">
                            {Object.values(VulnerabilityStatus).map(st => <option key={st} value={st}>{st}</option>)}
                        </select>
                    </div>
                </div>

                <div>
                    <label htmlFor="description" className="block text-sm font-medium text-on-surface-dark-secondary mb-1">Descrição Técnica</label>
                    <textarea name="description" value={formData.description} onChange={handleChange} rows={3} className={`w-full bg-gray-700 border text-white rounded-md p-2 ${errors.description ? 'border-red-500' : 'border-gray-600'}`}></textarea>
                    {errors.description && <p className="text-red-400 text-xs italic mt-1">{errors.description}</p>}
                </div>

                <div>
                    <label htmlFor="remediation" className="block text-sm font-medium text-on-surface-dark-secondary mb-1">Plano de Remediação / Workaround</label>
                    <textarea name="remediation" value={formData.remediation} onChange={handleChange} rows={2} placeholder="Ex: Aplicar patch KB500... ou desativar porta 445." className="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2"></textarea>
                </div>

                <div className="flex justify-end gap-4 pt-4 border-t border-gray-700">
                    <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-500">Cancelar</button>
                    <button type="submit" className="px-4 py-2 bg-brand-primary text-white rounded-md hover:bg-brand-secondary flex items-center gap-2">
                        <FaShieldAlt />
                        Salvar Registo
                    </button>
                </div>
            </form>
        </Modal>
    );
};

export default AddVulnerabilityModal;
